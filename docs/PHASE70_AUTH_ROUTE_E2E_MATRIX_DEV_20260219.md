# Phase 70: Auth/Route E2E Matrix - Development

## Date
2026-02-19

## Background
- Existing auth-recovery and route-fallback behavior had individual test coverage, but lacked a dedicated deterministic matrix for key terminal states.
- Recent no-blank-page and auth-recovery hardening needs a focused regression suite to prevent timing-based gaps.

## Goal
1. Add a standalone E2E matrix for auth/route recovery terminal states.
2. Keep assertions aligned with real runtime flow (bootstrap + PrivateRoute + login handoff).
3. Add a single wrapper script for fast local smoke execution.

## Changes

### 1) New auth/route matrix spec
- File: `ecm-frontend/e2e/auth-route-recovery.matrix.spec.ts`
- Added 4 deterministic scenarios:
  - login shows session-expired guidance from `?reason=session_expired`
  - auto-login pause guidance appears after protected-route handoff
  - unknown route falls back to login with non-blank terminal UI
  - login CTA reaches Keycloak auth endpoint (`/protocol/openid-connect/auth`)

### 2) Stable redirect-pause state seeding
- File: `ecm-frontend/e2e/auth-route-recovery.matrix.spec.ts`
- Implemented `seedRedirectPauseState(page)` with `page.addInitScript(..., args)` parameter passing.
- Seeded only redirect failure counters/time window markers so state is generated by `PrivateRoute` during real navigation, avoiding bootstrap-clear race.

### 3) Dedicated smoke wrapper
- File: `scripts/phase70-auth-route-matrix-smoke.sh`
- Added one-command execution with explicit prechecks:
  - API health endpoint
  - Keycloak OIDC discovery endpoint
  - UI reachability
  - E2E target mode validation (`check-e2e-target.sh`)
  - optional prebuilt sync reuse (`sync-prebuilt-frontend-if-needed.sh`)
- Runs only `auth-route-recovery.matrix.spec.ts` on configurable Playwright project/worker.

## Non-Functional Notes
- No backend/API contract changes.
- No production runtime code path changes; this phase adds targeted E2E coverage and a smoke script only.
