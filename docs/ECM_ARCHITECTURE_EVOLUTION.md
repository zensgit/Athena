# ECM Core æ¶æ„æ¼”è¿›ç­–ç•¥

> ä» Alfresco å’Œ Paperless-ngx å¸æ”¶çš„æ ¸å¿ƒè®¾è®¡ç†å¿µ
>
> æ–‡æ¡£ç‰ˆæœ¬: 1.0
>
> æ›´æ–°æ—¥æœŸ: 2025-12-09

---

## æ ¸å¿ƒæ´å¯Ÿï¼šä¸¤ä¸ªé¡¹ç›®çš„è®¾è®¡å“²å­¦

### Alfresco çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**ä¼ä¸šçº§å¯æ‰©å±•æ€§**

```
è®¾è®¡ç†å¿µ: "ä¸€åˆ‡çš†å¯é…ç½®ã€ä¸€åˆ‡çš†å¯æ‰©å±•"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Alfresco æ¶æ„ç‰¹ç‚¹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ç­–ç•¥é©±åŠ¨ (Policy-Driven)                                â”‚
â”‚     â””â”€ æ‰€æœ‰è¡Œä¸ºé€šè¿‡ç­–ç•¥/è¡Œä¸ºæ³¨å…¥ï¼Œè€Œéç¡¬ç¼–ç                   â”‚
â”‚                                                             â”‚
â”‚  2. æ¨¡å‹é©±åŠ¨ (Model-Driven)                                 â”‚
â”‚     â””â”€ å†…å®¹æ¨¡å‹é€šè¿‡ XML å®šä¹‰ï¼Œè¿è¡Œæ—¶å¯æ‰©å±•                   â”‚
â”‚                                                             â”‚
â”‚  3. æœåŠ¡æ€»çº¿ (Service Bus)                                  â”‚
â”‚     â””â”€ 92+ ç‹¬ç«‹æœåŠ¡ï¼Œé€šè¿‡æ¥å£æ¾è€¦åˆ                          â”‚
â”‚                                                             â”‚
â”‚  4. æƒé™å³æ•°æ® (Permission as Data)                         â”‚
â”‚     â””â”€ æƒé™æ¨¡å‹ä¹Ÿæ˜¯é…ç½®ï¼Œä¸æ˜¯ä»£ç                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Paperless-ngx çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**æ™ºèƒ½è‡ªåŠ¨åŒ–**

```
è®¾è®¡ç†å¿µ: "è®©æ–‡æ¡£è‡ªå·±æ‰¾åˆ°å½’å±"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Paperless-ngx æ¶æ„ç‰¹ç‚¹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. æ’ä»¶ç®¡é“ (Plugin Pipeline)                              â”‚
â”‚     â””â”€ æ–‡æ¡£å¤„ç†é€šè¿‡å¯æ’æ‹”çš„å¤„ç†å™¨é“¾                          â”‚
â”‚                                                             â”‚
â”‚  2. è§„åˆ™å¼•æ“ (Rule Engine)                                  â”‚
â”‚     â””â”€ ç”¨æˆ·å®šä¹‰è§„åˆ™ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ                            â”‚
â”‚                                                             â”‚
â”‚  3. æœºå™¨å­¦ä¹  (ML Integration)                               â”‚
â”‚     â””â”€ ä»ç”¨æˆ·è¡Œä¸ºä¸­å­¦ä¹ ï¼ŒæŒç»­æ”¹è¿›åˆ†ç±»                        â”‚
â”‚                                                             â”‚
â”‚  4. äº‹ä»¶é©±åŠ¨ (Event-Driven)                                 â”‚
â”‚     â””â”€ ä¿¡å·æœºåˆ¶é©±åŠ¨æ¾è€¦åˆçš„åŠŸèƒ½æ‰©å±•                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¶æ„å±‚é¢çš„æ”¹å˜

### 1.1 ä»"ç¡¬ç¼–ç "åˆ°"é…ç½®é©±åŠ¨"

#### å½“å‰é—®é¢˜
```java
// âŒ ECM Core å½“å‰: æƒé™ç±»å‹ç¡¬ç¼–ç åœ¨æšä¸¾ä¸­
public enum PermissionType {
    READ, WRITE, DELETE, CREATE_CHILDREN...
}

// âŒ æ·»åŠ æ–°æƒé™éœ€è¦ä¿®æ”¹ä»£ç ã€é‡æ–°ç¼–è¯‘
```

#### åº”è¯¥å˜æˆ
```java
// âœ… å€Ÿé‰´ Alfresco: æƒé™é€šè¿‡é…ç½®å®šä¹‰
// permission-definitions.yml
permissions:
  - name: READ
    displayName: "è¯»å–"
    includes: [READ_PROPERTIES, READ_CONTENT]
  - name: CUSTOM_APPROVE
    displayName: "è‡ªå®šä¹‰å®¡æ‰¹"
    includes: [READ, WRITE]

// ä»£ç ä¸­åŠ¨æ€åŠ è½½
@Service
public class PermissionDefinitionService {
    @PostConstruct
    public void loadPermissionDefinitions() {
        // ä» YAML/æ•°æ®åº“ åŠ è½½æƒé™å®šä¹‰
    }
}
```

#### æ”¹å˜è¦ç‚¹
| æ–¹é¢ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| æƒé™ç±»å‹ | æšä¸¾ç¡¬ç¼–ç  | YAML/DB é…ç½® |
| æƒé™ç»„ | æ—  | å¯é…ç½®æƒé™è§’è‰² |
| åŠ¨æ€æƒé™ | æ—  | ç­–ç•¥æ¥å£ + é…ç½® |

---

### 1.2 ä»"å•ä¸€å¤„ç†"åˆ°"ç®¡é“æ¶æ„"

#### å½“å‰é—®é¢˜
```java
// âŒ ECM Core å½“å‰: æ–‡æ¡£ä¸Šä¼ æ˜¯å•ä¸€æ–¹æ³•
@PostMapping("/upload")
public ResponseEntity<?> uploadDocument(MultipartFile file) {
    // æ‰€æœ‰é€»è¾‘åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­
    extractMetadata(file);
    storeContent(file);
    createVersion(file);
    indexDocument(file);
    // æ— æ³•æ’å…¥è‡ªå®šä¹‰å¤„ç†æ­¥éª¤
}
```

#### åº”è¯¥å˜æˆ
```java
// âœ… å€Ÿé‰´ Paperless-ngx: æ’ä»¶ç®¡é“æ¶æ„
public interface DocumentProcessor {
    ProcessingResult process(DocumentContext context);
    int getOrder(); // æ‰§è¡Œé¡ºåº
    boolean shouldProcess(DocumentContext context); // æ¡ä»¶åˆ¤æ–­
}

@Component
@Order(10)
public class MetadataExtractionProcessor implements DocumentProcessor {
    @Override
    public ProcessingResult process(DocumentContext context) {
        // æå–å…ƒæ•°æ®
        return ProcessingResult.continueProcessing();
    }
}

@Component
@Order(20)
public class VirusScanProcessor implements DocumentProcessor {
    // ç—…æ¯’æ‰«æ - å¯é€‰æ’ä»¶
}

@Component
@Order(30)
public class AutoClassificationProcessor implements DocumentProcessor {
    // ML è‡ªåŠ¨åˆ†ç±» - å¯é€‰æ’ä»¶
}

@Component
@Order(40)
public class WorkflowTriggerProcessor implements DocumentProcessor {
    // è§¦å‘å·¥ä½œæµ - å¯é€‰æ’ä»¶
}

// ç®¡é“æ‰§è¡Œå™¨
@Service
public class DocumentProcessingPipeline {
    @Autowired
    private List<DocumentProcessor> processors;

    public void process(DocumentContext context) {
        for (DocumentProcessor processor : processors) {
            if (processor.shouldProcess(context)) {
                ProcessingResult result = processor.process(context);
                if (result.shouldStop()) break;
            }
        }
    }
}
```

#### ç®¡é“æ¶æ„çš„ä¼˜åŠ¿
```
æ–‡æ¡£ä¸Šä¼ ç®¡é“:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Upload â†’ [Validation] â†’ [Virus Scan] â†’ [OCR] â†’ [MLåˆ†ç±»]     â”‚
â”‚           â†’ [è§„åˆ™åŒ¹é…] â†’ [å·¥ä½œæµè§¦å‘] â†’ [å­˜å‚¨] â†’ [ç´¢å¼•]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘ æ¯ä¸ªæ­¥éª¤éƒ½å¯æ’æ‹”ã€å¯é…ç½®
```

---

### 1.3 ä»"è¢«åŠ¨æŸ¥è¯¢"åˆ°"æ™ºèƒ½æ¨è"

#### å½“å‰é—®é¢˜
```java
// âŒ ECM Core å½“å‰: ç”¨æˆ·å¿…é¡»ä¸»åŠ¨æœç´¢
@GetMapping("/search")
public Page<Document> search(@RequestParam String query) {
    return searchService.search(query);
}
// ç³»ç»Ÿä¸ä¸»åŠ¨æä¾›ä»»ä½•å»ºè®®
```

#### åº”è¯¥å˜æˆ
```java
// âœ… å€Ÿé‰´ Paperless-ngx: æ™ºèƒ½å»ºè®®ç³»ç»Ÿ
@GetMapping("/documents/{id}/suggestions")
public SuggestionResponse getSuggestions(@PathVariable UUID id) {
    Document doc = documentService.getDocument(id);

    return SuggestionResponse.builder()
        .suggestedTags(classifierService.predictTags(doc.getContent()))
        .suggestedCategory(classifierService.predictCategory(doc.getContent()))
        .similarDocuments(searchService.findSimilar(doc))
        .relatedWorkflows(workflowService.findApplicable(doc))
        .build();
}

// æ–‡æ¡£ä¸Šä¼ æ—¶è‡ªåŠ¨åº”ç”¨å»ºè®®
@PostMapping("/upload")
public Document uploadWithSuggestions(MultipartFile file, boolean autoApply) {
    Document doc = createDocument(file);

    if (autoApply) {
        SuggestionResponse suggestions = getSuggestions(doc.getId());
        applyTopSuggestions(doc, suggestions);
    }

    return doc;
}
```

---

### 1.4 ä»"é™æ€è§„åˆ™"åˆ°"è‡ªå­¦ä¹ ç³»ç»Ÿ"

#### å½“å‰é—®é¢˜
```
ECM Core å½“å‰:
- æ— è‡ªåŠ¨åˆ†ç±»èƒ½åŠ›
- ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨æ‰“æ ‡ç­¾
- ç³»ç»Ÿä¸ä»ç”¨æˆ·è¡Œä¸ºä¸­å­¦ä¹ 
```

#### åº”è¯¥å˜æˆ
```java
// âœ… å€Ÿé‰´ Paperless-ngx: æœºå™¨å­¦ä¹ åˆ†ç±»å™¨

/**
 * æ–‡æ¡£åˆ†ç±»å™¨ - ä»ç”¨æˆ·è¡Œä¸ºä¸­å­¦ä¹ 
 */
@Service
public class DocumentClassifierService {

    private DocumentClassifier classifier;

    /**
     * è®­ç»ƒåˆ†ç±»å™¨
     * æ•°æ®æ¥æº: ç”¨æˆ·æ‰‹åŠ¨åˆ†ç±»çš„æ–‡æ¡£
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹è®­ç»ƒ
    public void trainClassifier() {
        // 1. æ”¶é›†è®­ç»ƒæ•°æ® - ç”¨æˆ·å·²åˆ†ç±»çš„æ–‡æ¡£
        List<TrainingDocument> trainingData = documentRepository
            .findByTagsIsNotEmptyOrCategoriesIsNotEmpty();

        // 2. è®­ç»ƒæ¨¡å‹
        classifier.train(trainingData);

        // 3. ä¿å­˜æ¨¡å‹
        classifier.save("/var/ecm/models/classifier.pkl");

        log.info("Classifier trained with {} documents", trainingData.size());
    }

    /**
     * é¢„æµ‹åˆ†ç±»
     */
    public ClassificationResult predict(String content) {
        return classifier.predict(content);
    }
}

/**
 * ç”¨æˆ·è¡Œä¸ºå­¦ä¹ 
 * å½“ç”¨æˆ·ä¿®æ­£ç³»ç»Ÿå»ºè®®æ—¶ï¼Œè®°å½•ç”¨äºæ”¹è¿›æ¨¡å‹
 */
@EventListener
public void onUserCorrection(UserCorrectionEvent event) {
    // è®°å½•ç”¨æˆ·ä¿®æ­£ï¼Œç”¨äºä¸‹æ¬¡è®­ç»ƒ
    trainingFeedbackRepository.save(new TrainingFeedback(
        event.getDocumentId(),
        event.getSuggestedTags(),
        event.getActualTags(),
        event.getUser()
    ));
}
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šåŠŸèƒ½å±‚é¢çš„æ”¹å˜

### 2.1 è§„åˆ™å¼•æ“ï¼šè®©ç”¨æˆ·å®šä¹‰è‡ªåŠ¨åŒ–

```java
/**
 * è§„åˆ™å¼•æ“ - ç”¨æˆ·å¯è§†åŒ–é…ç½®è‡ªåŠ¨åŒ–è§„åˆ™
 *
 * å€Ÿé‰´: Paperless-ngx WorkflowTrigger + Alfresco RuleService
 */
@Entity
@Table(name = "automation_rules")
public class AutomationRule {

    @Id
    private UUID id;

    private String name;

    // è§¦å‘æ¡ä»¶
    @Enumerated(EnumType.STRING)
    private TriggerType triggerType; // ON_CREATE, ON_UPDATE, ON_UPLOAD, SCHEDULED

    // åŒ¹é…æ¡ä»¶ (JSON)
    @Type(JsonBinaryType.class)
    private RuleCondition condition;

    // æ‰§è¡ŒåŠ¨ä½œ (JSON)
    @Type(JsonBinaryType.class)
    private List<RuleAction> actions;

    private boolean enabled;
    private int priority;
}

/**
 * è§„åˆ™æ¡ä»¶ - æ”¯æŒå¤æ‚è¡¨è¾¾å¼
 */
@Data
public class RuleCondition {
    private MatchType matchType; // ALL, ANY, NONE
    private List<Criterion> criteria;

    @Data
    public static class Criterion {
        private String field;      // name, mimeType, content, metadata.xxx
        private Operator operator; // CONTAINS, EQUALS, MATCHES, GREATER_THAN
        private Object value;
    }
}

/**
 * è§„åˆ™åŠ¨ä½œ
 */
@Data
public class RuleAction {
    private ActionType type; // ADD_TAG, SET_CATEGORY, MOVE_TO, NOTIFY, RUN_WORKFLOW
    private Map<String, Object> parameters;
}

/**
 * è§„åˆ™å¼•æ“æ‰§è¡Œå™¨
 */
@Service
public class RuleEngine {

    @EventListener
    public void onDocumentEvent(DocumentEvent event) {
        Document doc = event.getDocument();

        // æ‰¾åˆ°åŒ¹é…çš„è§„åˆ™
        List<AutomationRule> rules = ruleRepository
            .findByTriggerTypeAndEnabledTrue(event.getTriggerType());

        for (AutomationRule rule : rules) {
            if (matches(doc, rule.getCondition())) {
                executeActions(doc, rule.getActions());
            }
        }
    }

    private boolean matches(Document doc, RuleCondition condition) {
        // å®ç°å¤æ‚çš„æ¡ä»¶åŒ¹é…é€»è¾‘
    }

    private void executeActions(Document doc, List<RuleAction> actions) {
        for (RuleAction action : actions) {
            actionExecutors.get(action.getType()).execute(doc, action.getParameters());
        }
    }
}
```

### è§„åˆ™é…ç½®ç¤ºä¾‹ (UI å¯è§†åŒ–)

```yaml
# ç¤ºä¾‹è§„åˆ™: å‘ç¥¨è‡ªåŠ¨åˆ†ç±»
rule:
  name: "å‘ç¥¨è‡ªåŠ¨åˆ†ç±»"
  trigger: ON_UPLOAD
  condition:
    matchType: ANY
    criteria:
      - field: content
        operator: CONTAINS
        value: "å‘ç¥¨"
      - field: content
        operator: MATCHES
        value: "\\d{20}"  # å‘ç¥¨å·ç æ­£åˆ™
      - field: mimeType
        operator: EQUALS
        value: "application/pdf"
  actions:
    - type: ADD_TAG
      parameters:
        tagName: "å‘ç¥¨"
    - type: SET_CATEGORY
      parameters:
        categoryPath: "/è´¢åŠ¡/å‘ç¥¨"
    - type: SET_METADATA
      parameters:
        invoiceType: "auto-detected"
    - type: NOTIFY
      parameters:
        to: "finance@company.com"
        template: "new-invoice"
```

---

### 2.2 åŠ¨æ€æƒé™ï¼šä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è®¿é—®æ§åˆ¶

```java
/**
 * åŠ¨æ€æƒé™ç³»ç»Ÿ
 *
 * å€Ÿé‰´: Alfresco DynamicAuthority
 *
 * æ ¸å¿ƒç†å¿µ: æƒé™ä¸ä»…å–å†³äº"ä½ æ˜¯è°"ï¼Œè¿˜å–å†³äº"å½“å‰ä¸Šä¸‹æ–‡"
 */

// 1. åŠ¨æ€æƒé™æä¾›è€…æ¥å£
public interface DynamicAuthorityProvider {
    /**
     * æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦æˆäºˆæƒé™
     */
    boolean hasAuthority(PermissionContext context);

    /**
     * æä¾›è€…æ ‡è¯†
     */
    String getAuthorityName();

    /**
     * æ­¤æƒé™é€‚ç”¨äºå“ªäº›æ“ä½œ
     */
    Set<PermissionType> getApplicablePermissions();
}

// 2. å†…ç½®åŠ¨æ€æƒé™: æ‰€æœ‰è€…
@Component
public class OwnerDynamicAuthority implements DynamicAuthorityProvider {

    @Override
    public boolean hasAuthority(PermissionContext context) {
        return context.getCurrentUser().equals(context.getNode().getCreatedBy());
    }

    @Override
    public String getAuthorityName() {
        return "ROLE_OWNER";
    }

    @Override
    public Set<PermissionType> getApplicablePermissions() {
        return Set.of(PermissionType.values()); // æ‰€æœ‰è€…æ‹¥æœ‰å…¨éƒ¨æƒé™
    }
}

// 3. å†…ç½®åŠ¨æ€æƒé™: éƒ¨é—¨åŒäº‹
@Component
public class DepartmentColleagueDynamicAuthority implements DynamicAuthorityProvider {

    @Override
    public boolean hasAuthority(PermissionContext context) {
        User currentUser = userService.getUser(context.getCurrentUser());
        User owner = userService.getUser(context.getNode().getCreatedBy());
        return currentUser.getDepartment().equals(owner.getDepartment());
    }

    @Override
    public String getAuthorityName() {
        return "ROLE_DEPARTMENT_COLLEAGUE";
    }

    @Override
    public Set<PermissionType> getApplicablePermissions() {
        return Set.of(PermissionType.READ); // åŒéƒ¨é—¨åŒäº‹å¯è¯»
    }
}

// 4. å†…ç½®åŠ¨æ€æƒé™: å·¥ä½œæµå‚ä¸è€…
@Component
public class WorkflowParticipantDynamicAuthority implements DynamicAuthorityProvider {

    @Override
    public boolean hasAuthority(PermissionContext context) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯å½“å‰æ–‡æ¡£ç›¸å…³å·¥ä½œæµçš„å‚ä¸è€…
        return workflowService.isParticipant(
            context.getNode().getId(),
            context.getCurrentUser()
        );
    }

    @Override
    public String getAuthorityName() {
        return "ROLE_WORKFLOW_PARTICIPANT";
    }

    @Override
    public Set<PermissionType> getApplicablePermissions() {
        return Set.of(PermissionType.READ, PermissionType.WRITE);
    }
}

// 5. æƒé™æ£€æŸ¥æ—¶æ•´åˆåŠ¨æ€æƒé™
@Service
public class EnhancedSecurityService {

    @Autowired
    private List<DynamicAuthorityProvider> dynamicProviders;

    public boolean hasPermission(Node node, PermissionType permission, String username) {
        PermissionContext context = new PermissionContext(node, username, permission);

        // 1. æ£€æŸ¥åŠ¨æ€æƒé™
        for (DynamicAuthorityProvider provider : dynamicProviders) {
            if (provider.getApplicablePermissions().contains(permission)) {
                if (provider.hasAuthority(context)) {
                    return true;
                }
            }
        }

        // 2. æ£€æŸ¥é™æ€æƒé™ (ACL)
        return checkStaticPermissions(node, permission, username);
    }
}
```

---

### 2.3 å†…å®¹æ¨¡å‹ï¼šå¯æ‰©å±•çš„å…ƒæ•°æ®

```java
/**
 * å¯æ‰©å±•å†…å®¹æ¨¡å‹
 *
 * å€Ÿé‰´: Alfresco Content Model + Paperless-ngx CustomField
 *
 * æ ¸å¿ƒç†å¿µ: ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå·±çš„æ–‡æ¡£ç±»å‹å’Œå±æ€§ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
 */

// 1. å†…å®¹ç±»å‹å®šä¹‰
@Entity
@Table(name = "content_type_definitions")
public class ContentTypeDefinition {

    @Id
    private UUID id;

    private String name;        // invoice, contract, report
    private String displayName; // å‘ç¥¨, åˆåŒ, æŠ¥å‘Š
    private String parentType;  // ç»§æ‰¿è‡ªå“ªä¸ªç±»å‹

    @OneToMany(cascade = CascadeType.ALL)
    private List<PropertyDefinition> properties;

    @OneToMany(cascade = CascadeType.ALL)
    private List<AspectDefinition> mandatoryAspects;
}

// 2. å±æ€§å®šä¹‰
@Entity
@Table(name = "property_definitions")
public class PropertyDefinition {

    @Id
    private UUID id;

    private String name;
    private String displayName;

    @Enumerated(EnumType.STRING)
    private PropertyType type; // STRING, INTEGER, DATE, BOOLEAN, LIST, NODE_REF

    private boolean required;
    private boolean indexed;     // æ˜¯å¦åŠ å…¥æœç´¢ç´¢å¼•
    private boolean searchable;  // æ˜¯å¦æ”¯æŒå…¨æ–‡æœç´¢

    private String defaultValue;
    private String validationRegex;

    @Type(JsonBinaryType.class)
    private List<String> allowedValues; // æšä¸¾å€¼
}

// 3. æ–¹é¢å®šä¹‰ (Aspect - å¯é™„åŠ åˆ°ä»»ä½•ç±»å‹çš„å±æ€§é›†)
@Entity
@Table(name = "aspect_definitions")
public class AspectDefinition {

    @Id
    private UUID id;

    private String name;        // auditable, versionable, taggable
    private String displayName;

    @OneToMany(cascade = CascadeType.ALL)
    private List<PropertyDefinition> properties;
}

// 4. å†…å®¹æ¨¡å‹æœåŠ¡
@Service
public class ContentModelService {

    /**
     * åˆ›å»ºè‡ªå®šä¹‰æ–‡æ¡£ç±»å‹
     */
    public ContentTypeDefinition createContentType(CreateTypeRequest request) {
        ContentTypeDefinition type = new ContentTypeDefinition();
        type.setName(request.getName());
        type.setDisplayName(request.getDisplayName());
        type.setParentType(request.getParentType());
        type.setProperties(request.getProperties());

        // éªŒè¯
        validateTypeDefinition(type);

        // ä¿å­˜
        ContentTypeDefinition saved = typeRepository.save(type);

        // æ›´æ–°æœç´¢ç´¢å¼• schema
        searchIndexService.updateSchema(saved);

        return saved;
    }

    /**
     * éªŒè¯æ–‡æ¡£æ˜¯å¦ç¬¦åˆç±»å‹å®šä¹‰
     */
    public ValidationResult validateDocument(Document doc, String typeName) {
        ContentTypeDefinition type = getTypeDefinition(typeName);
        List<ValidationError> errors = new ArrayList<>();

        for (PropertyDefinition prop : type.getProperties()) {
            Object value = doc.getProperty(prop.getName());

            if (prop.isRequired() && value == null) {
                errors.add(new ValidationError(prop.getName(), "Required property is missing"));
            }

            if (value != null && prop.getValidationRegex() != null) {
                if (!Pattern.matches(prop.getValidationRegex(), value.toString())) {
                    errors.add(new ValidationError(prop.getName(), "Value does not match pattern"));
                }
            }
        }

        return new ValidationResult(errors.isEmpty(), errors);
    }
}
```

#### å†…å®¹ç±»å‹é…ç½®ç¤ºä¾‹

```yaml
# è‡ªå®šä¹‰å†…å®¹ç±»å‹: å‘ç¥¨
contentType:
  name: ecm:invoice
  displayName: "å‘ç¥¨"
  parentType: ecm:document
  properties:
    - name: invoiceNumber
      displayName: "å‘ç¥¨å·ç "
      type: STRING
      required: true
      indexed: true
      validationRegex: "^\\d{20}$"
    - name: invoiceDate
      displayName: "å¼€ç¥¨æ—¥æœŸ"
      type: DATE
      required: true
      indexed: true
    - name: amount
      displayName: "é‡‘é¢"
      type: DECIMAL
      required: true
    - name: vendor
      displayName: "ä¾›åº”å•†"
      type: STRING
      indexed: true
    - name: invoiceType
      displayName: "å‘ç¥¨ç±»å‹"
      type: LIST
      allowedValues: ["å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨", "å¢å€¼ç¨æ™®é€šå‘ç¥¨", "ç”µå­å‘ç¥¨"]
  mandatoryAspects:
    - ecm:auditable
    - ecm:versionable
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæŠ€æœ¯å±‚é¢çš„æ”¹å˜

### 3.1 ä»åŒæ­¥åˆ°å¼‚æ­¥

```java
/**
 * å¼‚æ­¥å¤„ç†æ¶æ„
 *
 * å€Ÿé‰´: Paperless-ngx Celery + Alfresco Action Service
 */

// 1. æ–‡æ¡£å¤„ç†å¼‚æ­¥åŒ–
@Service
public class AsyncDocumentService {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    /**
     * å¼‚æ­¥å¤„ç†æ–‡æ¡£ä¸Šä¼ 
     */
    public DocumentUploadTask uploadDocumentAsync(MultipartFile file, UploadOptions options) {
        // 1. ä¿å­˜åŸå§‹æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
        String tempPath = storeTempFile(file);

        // 2. åˆ›å»ºä»»åŠ¡
        DocumentUploadTask task = new DocumentUploadTask();
        task.setId(UUID.randomUUID());
        task.setStatus(TaskStatus.PENDING);
        task.setTempFilePath(tempPath);
        task.setOptions(options);
        taskRepository.save(task);

        // 3. å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        rabbitTemplate.convertAndSend("document.upload", task.getId().toString());

        // 4. ç«‹å³è¿”å›ä»»åŠ¡ ID
        return task;
    }

    /**
     * æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
     */
    public DocumentUploadTask getTaskStatus(UUID taskId) {
        return taskRepository.findById(taskId)
            .orElseThrow(() -> new NotFoundException("Task not found"));
    }
}

// 2. æ¶ˆæ¯æ¶ˆè´¹è€…
@Component
@RabbitListener(queues = "document.upload")
public class DocumentUploadConsumer {

    @RabbitHandler
    public void handleUpload(String taskId) {
        DocumentUploadTask task = taskRepository.findById(UUID.fromString(taskId)).get();

        try {
            task.setStatus(TaskStatus.PROCESSING);
            taskRepository.save(task);

            // æ‰§è¡Œå¤„ç†ç®¡é“
            documentPipeline.process(task);

            task.setStatus(TaskStatus.COMPLETED);
            task.setResultDocumentId(/* ... */);
        } catch (Exception e) {
            task.setStatus(TaskStatus.FAILED);
            task.setErrorMessage(e.getMessage());
        }

        taskRepository.save(task);

        // é€šçŸ¥å®¢æˆ·ç«¯ (WebSocket)
        notificationService.notifyTaskComplete(task);
    }
}

// 3. å‰ç«¯è½®è¯¢/WebSocket è·å–è¿›åº¦
@GetMapping("/tasks/{taskId}")
public TaskStatusResponse getTaskStatus(@PathVariable UUID taskId) {
    DocumentUploadTask task = asyncDocumentService.getTaskStatus(taskId);
    return TaskStatusResponse.builder()
        .taskId(task.getId())
        .status(task.getStatus())
        .progress(task.getProgress())
        .resultDocumentId(task.getResultDocumentId())
        .errorMessage(task.getErrorMessage())
        .build();
}
```

### 3.2 ä»å•ä½“åˆ°æ¨¡å—åŒ–

```
å½“å‰æ¶æ„ (å•ä½“):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ECM Core                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Node â”‚Ver. â”‚Perm.â”‚Searchâ”‚Work.â”‚       â”‚
â”‚  â”‚Svc  â”‚Svc  â”‚Svc  â”‚Svc  â”‚Svc  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®æ ‡æ¶æ„ (æ¨¡å—åŒ–):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ECM Core                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Core Module              â”‚   â”‚  â† æ ¸å¿ƒæ¨¡å— (å¿…é¡»)
â”‚  â”‚  Node, Version, Permission       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Search Module            â”‚   â”‚  â† æœç´¢æ¨¡å— (å¯é€‰)
â”‚  â”‚  Elasticsearch, Facet, Suggest   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       Workflow Module            â”‚   â”‚  â† å·¥ä½œæµæ¨¡å— (å¯é€‰)
â”‚  â”‚  Flowable, Task, Rule Engine     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Intelligence Module          â”‚   â”‚  â† æ™ºèƒ½æ¨¡å— (å¯é€‰)
â”‚  â”‚  ML Classifier, OCR, NLP         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Integration Module          â”‚   â”‚  â† é›†æˆæ¨¡å— (å¯é€‰)
â”‚  â”‚  Odoo, Email, Webhook            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Maven æ¨¡å—ç»“æ„

```xml
<!-- ecm-parent/pom.xml -->
<modules>
    <module>ecm-core</module>           <!-- æ ¸å¿ƒæ¨¡å— -->
    <module>ecm-search</module>         <!-- æœç´¢æ¨¡å— -->
    <module>ecm-workflow</module>       <!-- å·¥ä½œæµæ¨¡å— -->
    <module>ecm-intelligence</module>   <!-- æ™ºèƒ½æ¨¡å— -->
    <module>ecm-integration</module>    <!-- é›†æˆæ¨¡å— -->
    <module>ecm-app</module>            <!-- å¯åŠ¨æ¨¡å— -->
</modules>
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šæ”¹å˜ä¼˜å…ˆçº§æ€»ç»“

### é«˜ä¼˜å…ˆçº§ (ç«‹å³å®æ–½)

| æ”¹å˜ | æ¥æº | ä»·å€¼ | å¤æ‚åº¦ |
|------|------|:----:|:------:|
| æ–‡æ¡£å¤„ç†ç®¡é“æ¶æ„ | Paperless | ğŸ”¥ğŸ”¥ğŸ”¥ | â­â­ |
| åŠ¨æ€æƒé™ç³»ç»Ÿ | Alfresco | ğŸ”¥ğŸ”¥ğŸ”¥ | â­â­â­ |
| è§„åˆ™å¼•æ“ | Both | ğŸ”¥ğŸ”¥ğŸ”¥ | â­â­â­ |
| å¼‚æ­¥ä»»åŠ¡å¤„ç† | Paperless | ğŸ”¥ğŸ”¥ | â­â­ |

### ä¸­ä¼˜å…ˆçº§ (è¿­ä»£å®æ–½)

| æ”¹å˜ | æ¥æº | ä»·å€¼ | å¤æ‚åº¦ |
|------|------|:----:|:------:|
| ML è‡ªåŠ¨åˆ†ç±» | Paperless | ğŸ”¥ğŸ”¥ğŸ”¥ | â­â­â­â­ |
| å¯é…ç½®æƒé™æ¨¡å‹ | Alfresco | ğŸ”¥ğŸ”¥ | â­â­â­ |
| è‡ªå®šä¹‰å†…å®¹ç±»å‹ | Alfresco | ğŸ”¥ğŸ”¥ | â­â­â­ |
| æ¨¡å—åŒ–æ¶æ„ | Both | ğŸ”¥ğŸ”¥ | â­â­â­â­ |

### ä½ä¼˜å…ˆçº§ (é•¿æœŸç›®æ ‡)

| æ”¹å˜ | æ¥æº | ä»·å€¼ | å¤æ‚åº¦ |
|------|------|:----:|:------:|
| å®Œæ•´ç­–ç•¥æ¡†æ¶ | Alfresco | ğŸ”¥ | â­â­â­â­ |
| å¤šç§Ÿæˆ·æ”¯æŒ | Alfresco | ğŸ”¥ | â­â­â­â­â­ |

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå…·ä½“å®æ–½å»ºè®®

### Phase 1: ç®¡é“ + åŠ¨æ€æƒé™ (2å‘¨)

```
Week 1:
â”œâ”€â”€ å®ç° DocumentProcessor æ¥å£
â”œâ”€â”€ å®ç°å¤„ç†ç®¡é“æ‰§è¡Œå™¨
â”œâ”€â”€ é‡æ„æ–‡æ¡£ä¸Šä¼ ä¸ºç®¡é“æ¨¡å¼
â””â”€â”€ æ·»åŠ  2-3 ä¸ªå¤„ç†å™¨ (å…ƒæ•°æ®æå–ã€ç´¢å¼•ã€é€šçŸ¥)

Week 2:
â”œâ”€â”€ å®ç° DynamicAuthorityProvider æ¥å£
â”œâ”€â”€ å®ç° OwnerDynamicAuthority
â”œâ”€â”€ å®ç° LockOwnerDynamicAuthority
â”œâ”€â”€ é›†æˆåˆ° SecurityService
â””â”€â”€ å•å…ƒæµ‹è¯•
```

### Phase 2: è§„åˆ™å¼•æ“ (2å‘¨)

```
Week 3:
â”œâ”€â”€ è®¾è®¡è§„åˆ™æ•°æ®æ¨¡å‹
â”œâ”€â”€ å®ç°è§„åˆ™æ¡ä»¶åŒ¹é…å™¨
â”œâ”€â”€ å®ç°è§„åˆ™åŠ¨ä½œæ‰§è¡Œå™¨
â””â”€â”€ åˆ›å»ºè§„åˆ™ç®¡ç† API

Week 4:
â”œâ”€â”€ é›†æˆåˆ°æ–‡æ¡£äº‹ä»¶ç›‘å¬
â”œâ”€â”€ æ·»åŠ è§„åˆ™ç®¡ç† UI API
â”œâ”€â”€ å®ç°è§„åˆ™å¯¼å…¥/å¯¼å‡º
â””â”€â”€ é›†æˆæµ‹è¯•
```

### Phase 3: æ™ºèƒ½åˆ†ç±» (3å‘¨)

```
Week 5-6:
â”œâ”€â”€ è®¾è®¡ ML æœåŠ¡æ¥å£
â”œâ”€â”€ å®ç° Python åˆ†ç±»å™¨è„šæœ¬
â”œâ”€â”€ å®ç° Java-Python é€šä¿¡
â”œâ”€â”€ è®­ç»ƒæ•°æ®å¯¼å‡ºåŠŸèƒ½
â””â”€â”€ å®šæ—¶è®­ç»ƒä»»åŠ¡

Week 7:
â”œâ”€â”€ é›†æˆåˆ°æ–‡æ¡£ä¸Šä¼ ç®¡é“
â”œâ”€â”€ å®ç°å»ºè®® API
â”œâ”€â”€ å®ç°ç”¨æˆ·åé¦ˆæ”¶é›†
â””â”€â”€ ç«¯åˆ°ç«¯æµ‹è¯•
```

---

## æ€»ç»“

### æ ¸å¿ƒç†å¿µè½¬å˜

| ä» | åˆ° | æ¥æº |
|----|----|------|
| ç¡¬ç¼–ç  | é…ç½®é©±åŠ¨ | Alfresco |
| å•ä¸€å¤„ç† | ç®¡é“æ¶æ„ | Paperless |
| è¢«åŠ¨å“åº” | ä¸»åŠ¨æ¨è | Paperless |
| é™æ€è§„åˆ™ | è‡ªå­¦ä¹  | Paperless |
| åŒæ­¥å¤„ç† | å¼‚æ­¥ä»»åŠ¡ | Both |
| å•ä½“æ¶æ„ | æ¨¡å—åŒ– | Both |

### ä¸€å¥è¯æ€»ç»“

> **ä»"åŠŸèƒ½å®ç°"è½¬å˜ä¸º"å¹³å°æ€ç»´"ï¼šä¸æ˜¯ç»™ç”¨æˆ·æä¾›åŠŸèƒ½ï¼Œè€Œæ˜¯ç»™ç”¨æˆ·æä¾›é…ç½®å’Œæ‰©å±•è‡ªå·±åŠŸèƒ½çš„èƒ½åŠ›ã€‚**

---

> æ–‡æ¡£ç‰ˆæœ¬: 1.0
>
> æ›´æ–°æ—¥æœŸ: 2025-12-09
