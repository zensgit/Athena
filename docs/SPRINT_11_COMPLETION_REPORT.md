# 功能开发报告：邮件自动化 (Sprint 11)

> **版本**: 1.0
> **日期**: 2025-12-10
> **状态**: ✅ 已完成

## 1. 概述

为了实现“主动摄取”能力，我们借鉴了 Paperless-ngx 的设计，实现了基于 IMAP 协议的邮件抓取与处理服务。系统现在可以像人类一样定期检查邮箱，自动下载附件并归档。

## 2. 核心功能实现

### 2.1 账户管理 (`MailAccount`)
*   支持配置 IMAP 服务器地址、端口、用户名和密码。
*   支持 SSL/STARTTLS 安全连接选项。

### 2.2 规则引擎 (`MailRule`)
*   **过滤条件**: 支持按 `Subject` (主题) 和 `From` (发件人) 进行正则匹配。
*   **动作**: 匹配后自动将附件上传到指定文件夹，并打上特定标签。

### 2.3 抓取服务 (`MailFetcherService`)
*   **定时任务**: 默认每 5 分钟轮询一次所有启用的账户。
*   **处理流程**:
    1.  连接 IMAP。
    2.  搜索未读 (UNSEEN) 邮件。
    3.  遍历规则进行匹配。
    4.  提取附件，模拟文件上传。
    5.  标记邮件为已读。

## 3. API 接口

所有接口均位于 `/api/v1/integration/mail` 下，仅限管理员访问。

*   `GET /accounts`: 列出邮箱账户。
*   `POST /accounts`: 添加邮箱。
*   `GET /rules`: 列出处理规则。
*   `POST /rules`: 添加规则。
*   `POST /fetch`: 手动触发一次抓取。

## 4. 验证方法

1.  添加一个测试用的 IMAP 账户 (如 Gmail/Outlook，需开启应用密码)。
2.  添加一条规则: Subject 包含 "Invoice", Action: Assign to "Finance" folder.
3.  向该邮箱发送一封带附件的邮件，主题为 "Invoice #123"。
4.  调用 `POST /fetch` 或等待 5 分钟。
5.  检查 ECM 系统中是否出现了该附件，且位于 Finance 文件夹。

## 5. 后续计划

*   **OAuth2 支持**: 现代邮箱 (Gmail/O365) 逐步强制使用 OAuth2，未来需升级认证方式。
*   **正文归档**: 目前仅处理附件，后续可将邮件正文转换为 HTML/PDF 归档。
