# Athena ECM 实施计划

## 0. 基线与目标
- 基线：上传管道、全文+分面搜索、规则引擎、动态权限/分享/回收站、Folder 树与前端浏览/搜索已存在。
- 目标：稳定现有能力、补齐测试和运行配置，逐步演进至工作流/分析/集成等 Roadmap 能力。

## 1. 环境与配置（Week 1）
- 配置固化：`application-docker.yml` 与 `.env` 明确 Postgres/Redis/ES/Rabbit/MinIO/ML 主机端口；JOD 转换开关；提供一键启动 compose profile。
- 运行脚本：新增 `scripts/smoke.sh` 串联启动→冒烟（上传→搜索→规则触发→分享→回收站恢复）。
- 观测：暴露健康/指标端点（管道队列、索引重建状态、规则执行耗时）。

## 2. 质量与测试（Week 1–2）
- 管道 E2E：集成测试覆盖上传→存储→Tika→PG→ES→搜索高亮（含失败容错）。
- 规则引擎：触发类型（DOCUMENT_CREATED/TAGGED 等）与动作幂等/回滚测试；模板验证接口。
- 权限/分享/回收站：契约测试（密码/过期/IP 白名单/限次），动态权限链覆盖 Owner/LockOwner/SameDept。
- 搜索：分面聚合、相似文档、索引重建幂等性；ES 映射和分页高亮断言。
- 前端：FileBrowser/SearchResults 基础 UI 测试（渲染/交互），错误态与加载态。

## 3. 运行稳定性（Week 2）
- 大文件与流控：上传大小/类型校验、分片或流式处理；转换/预览异步队列化。
- 重建作业：索引重建断点续跑、任务表记录、并发防抖；管道处理超时/重试策略。
- 配置健壮性：所有 @Value 属性提供默认值；禁用可选依赖（JOD/ML）时的降级路径。

## 4. 功能演进（Week 3–6）
- 管道扩展：ContentEnrichment（AI 分类/标签）、Thumbnail、Versioning、外部事件发布处理器。
- 规则与 ML：ML 客户端超时/降级/缓存；规则执行审计日志；规则模板库与“模拟执行”API/前端。
- 搜索体验：更多 facets（时间区间/大小区间）、拼写纠错/同义词、字段权重调优、基于多字段的相似推荐。
- 权限与分享：动态权限可配置（开关/优先级）；分享下载审计与限流；回收站批量恢复/清理作业。
- 性能：热点缓存（Folder 树、常用 facets），ES/PG/Redis 连接池调优。

## 5. Roadmap 后续（Week 6–12）
- 工作流/审批：轻量状态机或 BPMN 集成，任务分配与审批流。
- 分析与监控：使用统计、存储/索引健康报表、活动日志仪表盘。
- 集成：Office 365、邮件归档、外部 Webhook/连接器统一管理。
- 安全加强：ABAC/策略引擎、审计报表、密钥/凭证管理。

## 6. 交付节奏与验收
- 每周迭代：计划 → 开发 → 测试 → 冒烟 → 汇报。
- 验收清单：代码（含迁移）、API 契约、测试报告、运行/回滚指南、配置样例、一键冒烟脚本。
- 度量：管道成功率、规则执行耗时/错误率、搜索 QPS/延迟、高亮命中率、上传失败率、分享访问审计。

## 7. 风险与应对
- 外部依赖缺失（ML/JOD/MinIO）：提供明确降级与开关。
- ES/PG 数据不一致：索引重建幂等与定期校验。
- 大文件/高并发：流式处理、限流、队列化。
- 权限误判：动态权限规则优先级配置与审计日志。

## 8. 近期行动清单（可立即执行）
- 补全 `.env` 与 `application-docker.yml` 主机名与默认值；整理一键启动 + 冒烟脚本。
- 编写上传→搜索→规则→分享→回收站 E2E 测试；为分面搜索/索引重建/动态权限补契约测试。
- 前后端接口对齐（分页/过滤参数、错误提示），完善加载/错误态。
- 为可选依赖（JOD/ML）提供默认降级实现，避免启动失败。
