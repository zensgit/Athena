name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  backend:
    name: Backend Verify
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ecm-core

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Verify
        run: mvn -B -q verify

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ecm-frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ecm-frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx -p typescript@5.4.5 tsc --noEmit

      - name: Build
        run: npm run build

      - name: Unit tests
        run: npm test -- --passWithNoTests --watchAll=false

  frontend_e2e_core:
    name: Frontend E2E Core Gate
    runs-on: ubuntu-latest
    needs:
      - backend
      - frontend
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ecm-frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ecm-frontend
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Install Playwright browser
        working-directory: ecm-frontend
        run: npx playwright install --with-deps chromium

      - name: Start E2E stack
        run: |
          cat <<'EOF' > .env
          POSTGRES_DB=ecm_db
          POSTGRES_USER=ecm_user
          POSTGRES_PASSWORD=ecm_password
          REDIS_PASSWORD=redis_password
          RABBITMQ_USER=rabbitmq
          RABBITMQ_PASSWORD=rabbitmq_password
          MINIO_ACCESS_KEY=minio_access_key
          MINIO_SECRET_KEY=minio_secret_key
          KEYCLOAK_USER=admin
          KEYCLOAK_PASSWORD=admin
          KEYCLOAK_DB_USER=keycloak
          KEYCLOAK_DB_PASSWORD=keycloak_password
          ODOO_DB_USER=odoo
          ODOO_DB_PASSWORD=odoo_password
          ECM_API_PORT=7700
          ECM_FRONTEND_PORT=5500
          KEYCLOAK_PORT=8180
          EOF
          cat <<'EOF' > .env.mail
          # CI placeholder for mail automation settings (optional)
          EOF

          if command -v docker-compose >/dev/null 2>&1; then
            DC="docker-compose"
          else
            DC="docker compose"
          fi

          # Keep the E2E gate stack minimal to reduce resource contention on CI runners.
          # WOPI is disabled for this gate, so Collabora is unnecessary. Mail automation is also out of scope here.
          ECM_WOPI_ENABLED=false ECM_ANTIVIRUS_ENABLED=true ECM_PREVIEW_CAD_ENABLED=false \
            ${DC} up -d postgres redis rabbitmq minio keycloak postgres-keycloak elasticsearch clamav
          ECM_WOPI_ENABLED=false ECM_ANTIVIRUS_ENABLED=true ECM_PREVIEW_CAD_ENABLED=false \
            ${DC} up -d --build --no-deps ecm-core ecm-frontend

      - name: Wait for stack readiness
        run: |
          for i in {1..120}; do
            api_code="$(curl -sS -o /dev/null -w '%{http_code}' http://localhost:7700/actuator/health || true)"
            ui_code="$(curl -sS -o /dev/null -w '%{http_code}' http://localhost:5500/ || true)"
            kc_code="$(curl -sS -o /dev/null -w '%{http_code}' http://localhost:8180/realms/ecm/.well-known/openid-configuration || true)"
            echo "attempt=${i} api=${api_code} ui=${ui_code} keycloak=${kc_code}"
            if [[ "${api_code}" == "200" && "${ui_code}" == "200" && "${kc_code}" == "200" ]]; then
              exit 0
            fi
            sleep 5
          done
          echo "E2E stack readiness timed out"
          echo "actuator_health_body:"
          curl -sS http://localhost:7700/actuator/health || true
          echo
          exit 1

      - name: Run core E2E gate
        working-directory: ecm-frontend
        run: |
          ECM_UI_URL=http://localhost:5500 ECM_API_URL=http://localhost:7700 ECM_E2E_WORKERS=1 \
            npx playwright test --workers=1 \
              e2e/browse-acl.spec.ts \
              e2e/mfa-settings.spec.ts \
              e2e/pdf-preview.spec.ts \
              e2e/permissions-dialog.spec.ts \
              e2e/permission-templates.spec.ts \
              e2e/rules-manual-backfill-validation.spec.ts \
              e2e/search-highlight.spec.ts \
              e2e/search-preview-status.spec.ts \
              e2e/search-sort-pagination.spec.ts \
              e2e/search-view.spec.ts \
              e2e/version-details.spec.ts \
              e2e/version-share-download.spec.ts
          ECM_UI_URL=http://localhost:5500 ECM_API_URL=http://localhost:7700 ECM_E2E_WORKERS=1 \
            npx playwright test --workers=1 e2e/ui-smoke.spec.ts \
              --grep 'UI smoke: PDF upload \+ search \+ version history \+ preview|UI search download failure shows error toast'

      - name: Capture docker logs (on failure)
        if: failure()
        run: |
          mkdir -p tmp/ci-e2e-logs
          docker compose logs --no-color ecm-core > tmp/ci-e2e-logs/ecm-core.log || true
          docker compose logs --no-color ecm-frontend > tmp/ci-e2e-logs/ecm-frontend.log || true
          docker compose logs --no-color keycloak > tmp/ci-e2e-logs/keycloak.log || true
          docker compose logs --no-color postgres > tmp/ci-e2e-logs/postgres.log || true
          docker compose logs --no-color elasticsearch > tmp/ci-e2e-logs/elasticsearch.log || true
          docker compose logs --no-color redis > tmp/ci-e2e-logs/redis.log || true

      - name: Upload E2E artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-e2e-core-artifacts
          path: |
            ecm-frontend/playwright-report
            ecm-frontend/test-results
            tmp/ci-e2e-logs
          if-no-files-found: ignore

      - name: Shutdown E2E stack
        if: always()
        run: docker compose down -v

  phase_c_security:
    name: Phase C Security Verification
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - uses: actions/checkout@v4

      - name: Start verification stack
        run: |
          cat <<'EOF' > .env
          POSTGRES_DB=ecm_db
          POSTGRES_USER=ecm_user
          POSTGRES_PASSWORD=ecm_password
          REDIS_PASSWORD=redis_password
          RABBITMQ_USER=rabbitmq
          RABBITMQ_PASSWORD=rabbitmq_password
          MINIO_ACCESS_KEY=minio_access_key
          MINIO_SECRET_KEY=minio_secret_key
          KEYCLOAK_USER=admin
          KEYCLOAK_PASSWORD=admin
          KEYCLOAK_DB_USER=keycloak
          KEYCLOAK_DB_PASSWORD=keycloak_password
          ODOO_DB_USER=odoo
          ODOO_DB_PASSWORD=odoo_password
          ECM_API_PORT=8080
          KEYCLOAK_PORT=8180
          EOF
          cat <<'EOF' > .env.mail
          # CI placeholder for mail automation settings (optional)
          EOF
          if command -v docker-compose >/dev/null 2>&1; then
            DC="docker-compose"
          else
            DC="docker compose"
          fi
          ECM_WOPI_ENABLED=false ECM_ANTIVIRUS_ENABLED=false ECM_PREVIEW_CAD_ENABLED=false \
            ${DC} up -d postgres redis rabbitmq minio keycloak postgres-keycloak elasticsearch
          ECM_WOPI_ENABLED=false ECM_ANTIVIRUS_ENABLED=false ECM_PREVIEW_CAD_ENABLED=false \
            ${DC} up -d --no-deps ecm-core

      - name: Run Phase C verification
        run: |
          ./scripts/verify.sh --no-restart --smoke-only --skip-build --skip-wopi

      - name: Collect verification logs (on failure)
        if: failure()
        run: |
          ls -la tmp || true
          latest_log="$(ls -t tmp/*verify-phase-c.log 2>/dev/null | head -n 1)"
          if [[ -n "${latest_log}" ]]; then
            echo "Latest verify-phase-c log: ${latest_log}"
            tail -n 200 "${latest_log}" || true
          fi
          ls -t tmp/*.log 2>/dev/null | head -n 20 || true
          ls -t tmp/phase-c-*.json 2>/dev/null | head -n 5 || true
          docker compose logs ecm-core || true
          docker compose logs keycloak || true

      - name: Upload verification logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: phase-c-logs
          path: tmp
          if-no-files-found: ignore

      - name: Shutdown stack
        if: always()
        run: docker compose down -v
