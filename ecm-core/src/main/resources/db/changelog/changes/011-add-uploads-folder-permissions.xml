<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="011-1" author="ecm-system">
        <comment>Create uploads folder if missing</comment>
        <sql>
            WITH existing AS (
                SELECT id FROM nodes WHERE name = 'uploads' AND parent_id IS NULL LIMIT 1
            ),
            inserted AS (
                INSERT INTO nodes (
                    id, node_type, name, path, parent_id, properties, metadata,
                    is_locked, locked_by, locked_date, inherit_permissions, status,
                    created_date, last_modified_date, created_by, last_modified_by,
                    version, is_deleted, deleted_at, deleted_by, correspondent_id
                )
                SELECT
                    ${uuid_function}, 'FOLDER', 'uploads', '/uploads', NULL, '{}'::jsonb, '{}'::jsonb,
                    false, NULL, NULL, true, 'ACTIVE',
                    ${now}, ${now}, 'system', 'system',
                    0, false, NULL, NULL, NULL
                WHERE NOT EXISTS (SELECT 1 FROM existing)
                RETURNING id
            )
            INSERT INTO folders (id, folder_type)
            SELECT id, 'GENERAL' FROM inserted
            ON CONFLICT (id) DO NOTHING;
        </sql>
    </changeSet>

    <changeSet id="011-2" author="ecm-system">
        <comment>Grant everyone read/create on uploads folder</comment>
        <sql>
            WITH uploads AS (
                SELECT id FROM nodes WHERE name = 'uploads' AND parent_id IS NULL LIMIT 1
            )
            INSERT INTO permissions (
                id, node_id, authority, authority_type, permission,
                is_allowed, is_inherited, created_by
            )
            SELECT
                ${uuid_function}, uploads.id, 'EVERYONE', 'EVERYONE', perm.permission,
                true, false, 'system'
            FROM uploads
            CROSS JOIN (VALUES ('READ'), ('CREATE_CHILDREN')) AS perm(permission)
            WHERE NOT EXISTS (
                SELECT 1 FROM permissions p
                WHERE p.node_id = uploads.id
                  AND p.authority = 'EVERYONE'
                  AND p.authority_type = 'EVERYONE'
                  AND p.permission = perm.permission
                  AND p.is_allowed = true
            );
        </sql>
    </changeSet>

</databaseChangeLog>
