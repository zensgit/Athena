<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="018-add-mail-account-fetch-status-credential-key" author="codex">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="mail_accounts"/>
        </preConditions>
        <comment>Add OAuth credential key and last fetch status fields</comment>
        <addColumn tableName="mail_accounts">
            <column name="oauth_credential_key" type="VARCHAR(128)"/>
            <column name="last_fetch_at" type="TIMESTAMP"/>
            <column name="last_fetch_status" type="VARCHAR(32)"/>
            <column name="last_fetch_error" type="TEXT"/>
        </addColumn>
    </changeSet>

    <changeSet id="018-clear-mail-account-oauth-secrets" author="codex">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="mail_accounts"/>
        </preConditions>
        <comment>Clear stored OAuth secrets to enforce env-based credentials</comment>
        <sql>
            UPDATE mail_accounts
            SET
                oauth_client_id = NULL,
                oauth_client_secret = NULL,
                oauth_access_token = NULL,
                oauth_refresh_token = NULL,
                oauth_token_expires_at = NULL
        </sql>
    </changeSet>

</databaseChangeLog>
